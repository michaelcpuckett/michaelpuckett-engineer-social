<!doctype html>
<title>ShopGenie</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="/main.css" />
<h1>ShopGenie</h1>
<hr />
<div class="section">
  <h2>
    Edit Profile
  </h2>

  <div class="slider-container">
    <form>
      <div class="autocomplete-container">
        <input list="favorites-autocomplete-list" placeholder="Enter a food or dish..." />
        <datalist id="favorites-autocomplete-list"></datalist>
        <button type="submit">
          Add
        </button>
      </div>
    </form>
    <form>
      <fieldset-wrapper id="favorite-foods-fieldset">
        <fieldset>
          <legend>
            What are your favorite foods and what do you eat most often?
          </legend>

          {% for food in foodData %}
            <label>
              <input type="checkbox" name="favorite-food" value="{{ food.name }}" {% for favoriteFood in profile.favoriteFoods | splitOnComma %}{% if favoriteFood == food.name %}checked{% endif %}{% endfor %} />
              <img src="{{ food.imageUrl }}" aria-hidden="true" />
              <span>{{ food.name }}</span>
            </label>
          {% endfor %}
        </fieldset>
      </fieldset-wrapper>
    </form>
  </div>

  <script type="module">
    const favoriteFoodsFieldsetElement = window.document.querySelector('#favorite-foods-fieldset');
    const checkboxElements = Array.from(favoriteFoodsFieldsetElement.querySelectorAll('[type="checkbox"]'));
    for (const checkboxElement of checkboxElements) {
      checkboxElement.addEventListener('change', () => {
        if (checkboxElement.checked) {
          const value = checkboxElement.value || '';
          const outputElement = window.document.querySelector('#favorite-foods');
          outputElement.textContent = `${outputElement.textContent ? `${outputElement.textContent}, ` : ''}${value}`;
          const listItemElement = window.document.createElement('li');
          listItemElement.dataset.food = value;
          const removeButtonElement = window.document.createElement('button');
          removeButtonElement.setAttribute('type', 'button');
          removeButtonElement.classList.add('small');
          removeButtonElement.textContent = 'Remove';
          listItemElement.append(removeButtonElement);
          const valueTextNode = window.document.createTextNode(value);
          listItemElement.append(valueTextNode);
          outputElement.nextElementSibling.append(listItemElement);
        } else {
          const food = checkboxElement.value || '';
          const outputElement = window.document.querySelector('#favorite-foods');
          const itemsArray = outputElement.textContent.split(', ');
          itemsArray.splice(itemsArray.indexOf(food), 1);
          outputElement.textContent = itemsArray.join(', ');
          window.document.querySelector(`[data-food="${food}"]`).remove();
        }
      });
    }
  </script>

    <script type="module">
      const favoritesListInputElement = window.document.querySelector('[list="favorites-autocomplete-list"]');
      const datalistElement = favoritesListInputElement.nextElementSibling;
      const formElement = favoritesListInputElement.closest('form');

      formElement.addEventListener('submit', (event) => {
        event.preventDefault();
        const value = favoritesListInputElement.value || '';
        const outputElement = window.document.querySelector('#favorite-foods');
        outputElement.textContent = `${outputElement.textContent ? `${outputElement.textContent}, ` : ''}${value}`;
        const listItemElement = window.document.createElement('li');
        listItemElement.dataset.food = value;
        const removeButtonElement = window.document.createElement('button');
        removeButtonElement.setAttribute('type', 'button');
        removeButtonElement.classList.add('small');
        removeButtonElement.textContent = 'Remove';
        listItemElement.append(removeButtonElement);
        const valueTextNode = window.document.createTextNode(value);
        listItemElement.append(valueTextNode);
        outputElement.nextElementSibling.append(listItemElement);
        favoritesListInputElement.value = '';
        for (const element of Array.from(datalistElement.children)) {
          element.remove();
        }
      });

      favoritesListInputElement.addEventListener('input', (event) => {
        fetch('/get-suggestions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            query: favoritesListInputElement.value || '',
          }),
        }).then((response) => {
          return response.json();
        }).then((results) => {
          for (const element of Array.from(datalistElement.children)) {
            element.remove();
          }

          for (const suggestion of results.suggestions) {
            const optionElement = window.document.createElement('option');
            optionElement.setAttribute('value', suggestion);
            datalistElement.append(optionElement);
          }
        });
      });
    </script>
  <form id="edit-profile">
    <label>
      <output hidden id="favorite-foods">{{ profile.favoriteFoods }}</output>
      <ul aria-label="Favorite foods">
        {% if profile.favoriteFoods %}
          {% for food in profile.favoriteFoods.split(', ') %}
           <li data-food="{{ food }}"><button type="button" class="small">Remove</button>{{ food }} </li>
          {% endfor %}
        {% endif %}
      </ul>
      <script type="module">
        const outputElement = window.document.querySelector('#favorite-foods');
        outputElement.nextElementSibling.addEventListener('click', (event) => {
          const buttonElement = event.target;
          const food = Array.from(buttonElement.closest('li').childNodes).find(node => node.nodeType === Node.TEXT_NODE).textContent.trim();
          const itemsArray = outputElement.textContent.split(', ');
          console.log(itemsArray, food);
          itemsArray.splice(itemsArray.indexOf(food), 1);
          outputElement.textContent = itemsArray.join(', ');
          buttonElement.closest('li').remove();

          window.document.querySelector(`[name="favorite-food"][value="${food}"]`).checked = false;
        });
      </script>
      <small>
        Please include a variety of breakfast, lunch, dinner, and snack foods, such as:
        <br />
        eggs, toast, bacon, fruit smoothies, hummus, chips, bbq chicken, tikka masala, greek food, yogurt, blueberries.
      </small>
    </label>

    <label>
      <p>
        <strong>What are your least favorite foods?</strong>
      </p>
      <textarea id="least-favorite-foods" aria-label="Dietary Profile" placeholder="kale, corn, onions, pork">{{ profile.leastFavoriteFoods }}</textarea>
      <small>
        Items you list here will be swapped out.
      </small>
    </label>

    <label>
      <p>
        <strong>Are there any restrictions, such as allergies or a specific diet (keto, vegan, etc.)?</strong>
      </p>
      <textarea id="diet" placeholder="vegan, peanut allergy">{{ profile.diet }}</textarea>
    </label>

    <label>
      <p>
        <strong>Calorie/macro/dietary goals</strong>
      </p>
      <textarea id="dietary-goals" placeholder="2000 calories/day, lose weight">{{ profile.dietaryGoals }}</textarea>
    </label>

    <label>
      <p>
        <strong>How many people are you cooking for?</strong>
      </p>
      <textarea id="cooking-for" placeholder="2 adults, 3 children">{{ profile.cookingFor }}</textarea>
    </label>

    <br />
    <button type="submit">
      Continue
    </button>
    <p class="loader" hidden>Loading, please wait up to 2 minutes...</p>
  </form>
  <script type="module">
    window.document.querySelector('#edit-profile').addEventListener('submit', (event) => {
      event.preventDefault();

      window.document.querySelector('#edit-profile .loader').removeAttribute('hidden');

      const favoriteFoods = window.document.querySelector('#favorite-foods');
      const leastFavoriteFoods = window.document.querySelector('#least-favorite-foods');
      const diet = window.document.querySelector('#diet');
      const dietaryGoals = window.document.querySelector('#dietary-goals');
      const cookingFor = window.document.querySelector('#cooking-for');

      const profile = {
        favoriteFoods: favoriteFoods.value,
        leastFavoriteFoods: leastFavoriteFoods.value,
        diet: diet.value,
        dietaryGoals: dietaryGoals.value,
        cookingFor: cookingFor.value,
      };

      fetch('/edit-profile', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(profile),
      }).then((response) => {
        window.document.querySelector('#generate-meal-plan').dispatchEvent(new SubmitEvent('submit'));
      });
    });
  </script>
</div>


<form id="generate-meal-plan" action="/generate-meal-plan" method="POST" hidden>
  <button
    type="submit">
    Generate Meal Plan
  </button>
  <p class="loader" hidden>Loading, please wait up to 2 minutes...</p>
</form>

<script type="module">
  window.document.querySelector('#generate-meal-plan').addEventListener('submit', (event) => {
    event.preventDefault();

    window.document.querySelector('#generate-meal-plan .loader').removeAttribute('hidden');

    fetch('/generate-meal-plan', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
    }).then((response) => {
      window.location = new URL('/meal-plan', window.location);
    });
  });
</script>
